# Setup

## Installation
Python virtual env    
Depending on the python version you have, some notes on setting up a python virtual environment
dedicated to getting data out of the archive

```
python3.x -m venv venv3.x
```
e.g.
```
python3.6 -m venv venv3.6
python3.7 -m venv venv3.7
```

### make your python virtual env version specific
```
python3.7 -m venv venv3.7
source venv3.7/bin/activate
```
### upgrade venv default pip version for newer wheels
```
pip install -U pip setuptools wheel
```
### exit venv
```
deactivate
```

---

# Data

## Installation
### activate python virtual
```
source venv3.7/bin/activate
```
### install katdal for data extraction
```
pip install katdal
pip install python-casacore
pip cache purge
deactivate
```
### exit venv
```
deactivate
```

## Extraction
Get data from archive    
Using screen/tmux session
`tmux new -s g330` or
```
tmux ls
tmux a -t g330
```
### activate python virtual
```
source venv3.7/bin/activate
```
### extract wideband data
```
mvftoms.py -f --flags cam <katdaltoken>
```
### extract narrowband data
```
mvftoms.py -a -f --flags cam -C <chan,range> <katdaltoken>
```
### make ms read-only
```
chmod -w <msfile>.ms/
```
### [optional] create symbolic link for easy access
```
ln -s data/<msfile>.ms
```
### exit venv
```
deactivate
```

---

# Pipeline processing

## Installation
Install caracal
### activate python virtual
```
source venv3.7/bin/activate
```
### install processing pipeline software
```
# old branch has error in setjy models
pip install --no-cache-dir git+https://github.com/caracal-pipeline/caracal.git@add_polcal
# install newest master to correct the setjy model error
pip install --no-cache-dir git+https://github.com/caracal-pipeline/caracal.git
caracal -h
pip cache purge
deactivate
```
### exit venv
```
deactivate
```

## Processing
### config file
Construct the caracal pipeline config file (`<whatever>.yml`)    
Example config: widepand_pipeline.yml
### activate python virtual
```
source venv3.7/bin/activate
```
### caracal
Run pipeline
```
ln -s <scratch_data> ms-orig

caracal -c <config_file>.yml

# sw : start-worker
# ew : end-worker
caracal -c <config_file>.yml -sw general -ew transform__calibrators
```
To quickly clean up the temporary output products generated by caracal
```
make clean
```
To remove all output, as well as
```
make clobber
```
### exit venv
```
deactivate
```

---

# Visualisation
## Installation
### activate python virtual
```
source venv3.7/bin/activate
```
### install radiopadre
```
pip install git+https://github.com/ratt-ru/radiopadre-client.git@b1.2.x
```
### start server
go to the directory you want to run the server from
radiopadre is going to create hidden directories and files in that directory
```
run-radiopadre -V .
```

the first time this may take a long time since other installations and setups must happen    
once started look out for the following information
* carta
```
radiopadre.client: $ /usr/bin/carta --remote --root=/home/ruby/OH_masers --folder=/home/ruby/OH_masers --port=1028 --fport=1027
```
* jupyter notebooks
```
--NotebookApp.token='3cb92a77ddf14211a06468ba3e40b4c6'
[I 15:25:25.382 NotebookApp] http://localhost:1024/?token=...
```

you can see the system is listening on the relevant ports
```
ss -tpl
```

when you exit the session, the ports allocated will be released, but as usual this will take a little
time.
check which ports are still located with
```
ss -a
ss -a | grep TIME-
```
The number of ports should decrease as the resources are released
```
ss -a | grep TIME- | wc -l
```

### exit venv
```
deactivate
```

---

# Usage


## TMUX session
### start tmux session
```
tmux new -s radiopadre
```
### attach to tmux session
```
tmux a -t radiopadre
```
### activate python virtual
```
source venv3.7/bin/activate
```

## Radiopadre
### start server
```
run-radiopadre -V .
```
### note ports and tokes
* carta
```
/usr/bin/carta --remote --root=/home/ruby/OH_masers --folder=/home/ruby/OH_masers --port=1028 --fport=1027
```
* jupyter notebooks
```
--NotebookApp.token='66523c4525ad46b987f366d83b02e0fa'
--NotebookApp.custom_display_url='http://localhost:1024'
```

## Browser & ssh
Running the radiopadre software on the server and viewing it from your local system means you need to
do some port forwarding for jupyter notebooks
```
ssh -XY -L 5050:localhost:1024 com14
```
View the output notebooks with jupyter notebooks
```
http://localhost:5050
```
View the fits images with Carta
```
http://com14.science.kat.ac.za:1027/?socketUrl=ws://com14.science.kat.ac.za:1028
```

---

# Notes
### forward all ports [optional]
```
ssh -XY -L 5050:localhost:1024 -L 5051:localhost:1027 -L 5052:localhost:1028 com14
```
```
http://localhost:5050/tree?#notebooks
http://localhost:5052/?socketUrl=ws://localhost:5051
```

### uninstall
pip uninstall radiopadre-client
pip uninstall radiopadre


-fin-
